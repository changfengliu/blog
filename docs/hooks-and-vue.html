<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hooks API 在 Vue 中的实现分析 | 我的博客</title>
    <meta name="description" content="工程师改变世界">
    
    
    <link rel="preload" href="/blog/assets/css/0.styles.de31820d.css" as="style"><link rel="preload" href="/blog/assets/js/app.65fb4c50.js" as="script"><link rel="preload" href="/blog/assets/js/5.4bb80ee7.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.bc45980e.js"><link rel="prefetch" href="/blog/assets/js/11.9ab16bae.js"><link rel="prefetch" href="/blog/assets/js/2.2ce49fe4.js"><link rel="prefetch" href="/blog/assets/js/3.6a70a0b9.js"><link rel="prefetch" href="/blog/assets/js/4.9e475928.js"><link rel="prefetch" href="/blog/assets/js/6.6839bb8b.js"><link rel="prefetch" href="/blog/assets/js/7.67dc841c.js"><link rel="prefetch" href="/blog/assets/js/8.bb74f765.js"><link rel="prefetch" href="/blog/assets/js/9.b7147ea8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.de31820d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">我的博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/index.html" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">深入理解系列</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://changfengliu.github.io/css-deepen-understanding/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入理解JavaScript
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://changfengliu.github.io/css-deepen-understanding/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入理解CSS
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://changfengliu.github.io/css-deepen-understanding/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入理解HTML
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/blog/site/about.html" class="nav-link">About Me</a></div><div class="nav-item"><a href="https://github.com/changfengliu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/index.html" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">深入理解系列</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://changfengliu.github.io/css-deepen-understanding/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入理解JavaScript
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://changfengliu.github.io/css-deepen-understanding/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入理解CSS
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://changfengliu.github.io/css-deepen-understanding/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  深入理解HTML
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><a href="/blog/site/about.html" class="nav-link">About Me</a></div><div class="nav-item"><a href="https://github.com/changfengliu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/hooks-and-vue.html" class="active sidebar-link">Hooks API 在 Vue 中的实现分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/hooks-and-vue.html#hooks解决了什么问题" class="sidebar-link">Hooks解决了什么问题</a></li><li class="sidebar-sub-header"><a href="/blog/hooks-and-vue.html#hooks-是什么" class="sidebar-link">Hooks 是什么</a></li><li class="sidebar-sub-header"><a href="/blog/hooks-and-vue.html#hooks-api-的-vue-实现" class="sidebar-link">Hooks API 的 Vue 实现</a></li><li class="sidebar-sub-header"><a href="/blog/hooks-and-vue.html#结论" class="sidebar-link">结论</a></li></ul></li><li><a href="/blog/old/css-tricks.html" class="sidebar-link">关于CSS伪元素及伪类的使用</a></li><li><a href="/blog/old/js-ticker.html" class="sidebar-link">关于Web前端埋点的总结</a></li><li><a href="/blog/old/js-array-sort.html" class="sidebar-link">关于JavaScript Array Sort函数的坑</a></li><li><a href="/blog/old/chalk-code.html" class="sidebar-link">巧妙的属性链调用-Chalk源码解析</a></li><li><a href="/blog/old/global-image-onerror.html" class="sidebar-link">如何全局处理image onerror, 显示默认图片</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="hooks-api-在-vue-中的实现分析"><a href="#hooks-api-在-vue-中的实现分析" aria-hidden="true" class="header-anchor">#</a> Hooks API 在 Vue 中的实现分析</h1> <p>初次听到 React Hooks，是在其刚发布的那几天，网上铺天盖地的文章介绍它。看字面意思是 「React 钩子」，就想当然地理解应该是修改 React 组件的钩子吧。React 延伸的概念非常多，高阶组件、函数式、Render Props、Context、等等。又来了一个新概念，前端开发已经够复杂了！近两年一直用 Vue，觉得 React 相关的诸多特性，在 Vue 中也都有类似的解决方案，所以就没有立即去了解它。</p> <p>后来看到尤大在 <a href="https://www.bilibili.com/video/av36787459/" target="_blank" rel="noopener noreferrer">Vue 3.0 最近进展<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的视频中也提到了 Hooks API，并写了一个在 <a href="https://github.com/yyx990803/vue-hooks" target="_blank" rel="noopener noreferrer">Vue 中使用 Hooks 的 POC<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。看来 Hooks 还是挺重要的，于是马上找到官方的 React Hooks 文档与发布会的视频 -- 又一轮的恶补。</p> <p>看了相关资料，觉得 Hooks 的应用前景还是挺诱人的，解决了目前前端开发中的诸多痛点。不过 React Hooks 目前还在 alpha 阶段，不太完善，内置 Hooks 也不丰富。而 Vue 只有个 Hooks POC，Vue3.0 很可能会加上，但需要再等几个月。所以暂不建议在正式代码中使用。</p> <p>本篇文章着重解释一下我对 Hooks 的理解，以及 Hooks API 在 Vue 中的源码实现。也说明一下 Hooks 是个中立的概念，可以在任何框架中使用，非 React 所独有 😃。</p> <h2 id="hooks解决了什么问题"><a href="#hooks解决了什么问题" aria-hidden="true" class="header-anchor">#</a> Hooks解决了什么问题</h2> <p>在开始之前，我们先复述一下 Hooks 会帮我们解决什么问题。</p> <p>按照 Dan 的说法，React 项目的开发中遇到了以下几个痛点：</p> <ol><li>跨组件代码，难以复用。</li> <li>大组件，难以维护。</li> <li>组件树层级，往往嵌套很深。</li> <li>类组件，不容易理解。</li></ol> <p>当然 Vue 项目也是一样，这些问题其实也是相关联的。</p> <p>组件化的开发方式，我们将页面拆分成不同的组件，按自上而下的数据流，层层嵌套。代码结构的最小颗粒是组件。</p> <p>如果某些组件太大，我们就继续拆分成更小的组件，然后在父组件中调用它。
如果多组件之间有不少通用逻辑，我们就用 mixin 或 构建组件的继承体系。</p> <p>问题是，组件拆分，会使我们很容易不小心就把组件的层级搞得很深，增加系统复杂度不说，性能也可能受到影响。并且，有些组件的交互逻辑确实比较复杂，拆分不得，系统长期迭代下来，累积的代码量很大，相关联的逻辑分散在组件不同的生命周期中，难以维护。</p> <p>跨组件逻辑复用更加棘手！mixin 是一个双刃剑(参考: <a href="https://reactjs.org/blog/2016/07/13/mixins-considered-harmful.html" target="_blank" rel="noopener noreferrer">mixin 是有害的<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)；组件继承也不可取，虽然在强类型的面向对象语言(如:Java/C#)中，继承用着很好，但在 JavaScript 中总感到力不从心，也使得代码晦涩难懂；抽取 util 包也是一个惯用的做法，但，如果要抽取的公用逻辑需关联组件的本地状态呢，如果相关联的公用逻辑需要分散在组件的不同生命周期中呢，就搞不定了！这时候，我们往往就妥协了 -- 大组件/重复逻辑产生了。</p> <p>类组件也让人爱恨交织，一直以来我们也提倡用面向对象的方式抽象代码结构，在没有更好的解决方案之前，确实是个不错的选择。但我个人觉得在 JavaScript 中，特别是在基于 React/Vue 组件体系的开发中，并不很合适。我们经常需要奇技淫巧的手段使 JavaScript 类型能够支持 super、私有成员，并小心处理函数中 this 的指向。基于 JavaScript 的灵活性与强大的表现力，总能够找到正确书写代码的方式。问题是，这样的代码怎么维护呢，晦涩难懂、雷区遍布。单说 this，我们知道 JavaScript 的基于静态作用域的，即从源码上看，就能够推断变量的作用域，但 this 却是个例外，它是基于动态作用域的，就是说 this 的值是由调用者决定的。同一个方法，用不同的方式调用，其 this 指向完全不一样，使得我们不得不大量使用 bind，以保证 this 的指向。</p> <blockquote><p>关于 JavaScript 中的 this，感兴趣的同学，可参考：<a href="http://dmitrysoshnikov.com/ecmascript/chapter-3-this/" target="_blank" rel="noopener noreferrer">详解 this<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></blockquote> <p>如何解决这些痛点呢 -- Hooks !</p> <h2 id="hooks-是什么"><a href="#hooks-是什么" aria-hidden="true" class="header-anchor">#</a> Hooks 是什么</h2> <p>wikipedia 上关于 <a href="https://en.wikipedia.org/wiki/Hooking" target="_blank" rel="noopener noreferrer">hooks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的定义是：</p> <blockquote><p>The term hooking covers a range of techniques used to alter or augment the behavior of an operating system, of applications, or of other software components by intercepting function calls or messages or events passed between software components. Code that handles such intercepted function calls, events or messages is called a hook.</p></blockquote> <p>翻译成中文含义是：Hooks 包含了一系列技术，用于改变或增强操作系统、应用程序、软件组件的行为。这些技术通过拦截软件运行过程中的函数调用、消息、事件来实现。</p> <p>就是说通过 Hooks，我们能够后期改变或增强已有系统的运行时行为。那么，对应到 React/Vue，则 Hooks 是可以改变或增强组件运行时行为的代码模块。</p> <p>通过阅读 React Hooks 的技术文档，React 中强调 Hooks 只能在函数式组件中使用。函数式组件本质上是一个单纯的渲染函数，无状态，数据来源于外部。那么如何给组件添加本地状态，以及各种生命周期相关的业务逻辑呢？答案是：通过 Hooks。</p> <p>React 团队希望未来「函数式组件 + Hooks」成为开发组件的主要方式，那么 Hooks 应该有能力侵入组件生命周期的每个环节，以便为组件添加状态与行为。虽然目前 React 提供的 Hooks 还不够丰富，后续会逐渐完善。</p> <p>综上所述，我们发现，Hooks 可以使我们模块化开发的粒度更细，更函数式。组件的功能变成了由 Hooks 一点点地装配起来。这样的特性，恰恰解决了上面提到的4个痛点：代码复用、大组件、组件树过深、类组件问题。</p> <blockquote><p>本篇稍微理论化了一点，关于 React Hooks 的背景及示例，请参考：<a href="https://reactjs.org/docs/hooks-intro.html" target="_blank" rel="noopener noreferrer">Introducing Hooks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>React 提供了两个重要的内置 Hooks :</p> <ul><li>useState -- 为组件添加本地响应式状态。</li> <li>useEffect -- 为组件添加状态更新后，需要执行的副作用逻辑。</li></ul> <p>还有其它一些组件特性相关的内置 Hooks：useContext、useReducer、useMemo、useRef 等等。未来应该会出现更多的内置 Hooks。我们也可以基于这些内置 Hooks，实现自定义 Hooks。</p> <p>对于 Vue ，除了 useState、useEffect、useRef 与 React 一致外，还可以实现 useComputed、useMounted、useUpdated、useWatch 等内置 Hooks，以便能够更细致地为组件添加功能。</p> <h2 id="hooks-api-的-vue-实现"><a href="#hooks-api-的-vue-实现" aria-hidden="true" class="header-anchor">#</a> Hooks API 的 Vue 实现</h2> <p>这里分析一下 <a href="https://github.com/yyx990803/vue-hooks" target="_blank" rel="noopener noreferrer">尤大的Hooks POC of Vue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的源码实现，以便加深对 Hooks API 的理解。</p> <h3 id="withhooks"><a href="#withhooks" aria-hidden="true" class="header-anchor">#</a> withHooks</h3> <p>我们知道 React Hooks 只能在函数式组件中使用，Vue 中也要这样定义。</p> <p>withHooks 用于包装一个 Vue 版的函数式组件，在这个函数式组件中，您可以使用 Hooks 相关的功能。</p> <p>如，withHooks 使用示例：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> withHooks<span class="token punctuation">,</span> useData<span class="token punctuation">,</span> useComputed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue-hooks&quot;</span>

<span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token function">withHooks</span><span class="token punctuation">(</span>h <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">useData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> double <span class="token operator">=</span> <span class="token function">useComputed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> data<span class="token punctuation">.</span>count <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`count is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`double count is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>double<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> on<span class="token punctuation">:</span> <span class="token punctuation">{</span> click<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">.</span>count<span class="token operator">++</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'count++'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>代码中 withHooks 包装了一个函数式组件(渲染函数)，函数中通过 Hooks 为组件添加了一个本地状态 data，及一个计算属性 double。</p> <p>注意：代码中的 useData 与 useState 类似，下文会解释。</p> <p><strong>withHooks 实现细节：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> currentInstance <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> isMounting <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> callIndex <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">function</span> <span class="token function">ensureCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token string">`invalid hooks call: hooks can only be called in a function passed to withHooks.`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">withHooks</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        _state<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_effectStore <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_refsStore <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_computedStore <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">render</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callIndex <span class="token operator">=</span> <span class="token number">0</span>
      currentInstance <span class="token operator">=</span> <span class="token keyword">this</span>
      isMounting <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_vnode
      <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$attrs<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$props<span class="token punctuation">)</span>
      currentInstance <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">return</span> ret
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码中：</p> <p>withHooks 为组件添加了一个私有本地状态 _state，用于存储 useState/useData 所关联的状态值。</p> <p>在 created 中，为组件注入了一些支持 Hooks 所需要的存储类对象。</p> <p>重点是代码中的 render 函数：</p> <ul><li>callIndex，为 Hooks 相关的存储对象提供 key。这里每次渲染，都重置为 0，是为了能够根据调用次序匹配对应的 Hooks，这样处理也限制了 Hooks 只能在顶级代码中调用。</li> <li>currentInstance，结合 ensureCurrentInstance 函数，用于确保 Hooks 只能在函数式组件中使用。</li> <li>isMounting，用于标识组件的挂载状态</li></ul> <h3 id="usestate"><a href="#usestate" aria-hidden="true" class="header-anchor">#</a> useState</h3> <p>useState 用于为组件添加一个响应式的本地状态，及该状态相关的更新器。</p> <p>方法签名为：</p> <blockquote><p>const [state, setState] = useState(initialState);</p></blockquote> <p>setState 用于更新状态：</p> <blockquote><p>setState(newState);</p></blockquote> <p>如，useState 使用示例：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> withHooks<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue-hooks&quot;</span>
<span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token function">withHooks</span><span class="token punctuation">(</span>h <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`count is: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> on<span class="token punctuation">:</span> <span class="token punctuation">{</span> click<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;+&quot;</span> <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>代码中，通过 useState 为组件添加了一个本地状态 count 与更新状态值用的函数 setCount。</p> <p><strong>useState 实现细节:</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ensureCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token operator">++</span>callIndex
  <span class="token comment">// 获取组件实例的本地状态。</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>$data<span class="token punctuation">.</span>_state
  <span class="token comment">// 本地状态更新器，以自增id为键值，存储到本地状态中。</span>
  <span class="token keyword">const</span> <span class="token function-variable function">updater</span> <span class="token operator">=</span> newValue <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMounting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过$set保证其是响应式状态。</span>
    currentInstance<span class="token punctuation">.</span>$<span class="token keyword">set</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> id<span class="token punctuation">,</span> initial<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 返回响应式状态与更新器。</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>state<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> updater<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上代码很清晰地描述了 useState 是在组件中创建了一个本地的响应式状态，并生成了一个状态更新器。</p> <p>需要注意的是：</p> <ul><li>函数 ensureCurrentInstance 是为了确保 useState 必须在 render 中执行，也就是限制了必须在函数式组件中执行。</li> <li>以 callIndex 生成的自增 id 作为存储状态值的 key。说明 useState 需要依赖第一次渲染时的调用顺序来匹配过去的 state（每次渲染 callIndex 需要重置为0）。这也限制了 useState 必须在顶层代码中使用。</li> <li>其它 hooks 也必须遵循以上两点。</li></ul> <h3 id="useeffect"><a href="#useeffect" aria-hidden="true" class="header-anchor">#</a> useEffect</h3> <p>useEffect 用于添加组件状态更新后，需要执行一些副作用逻辑。</p> <p><strong>方法签名：</strong></p> <blockquote><p>void useEffect(rawEffect, deps)</p></blockquote> <p>useEffect 指定的副作用逻辑，会在组件挂载后执行一次、在每次组件渲染后根据指定的依赖有选择地执行、并在组件卸载时执行清理逻辑(如果指定了的话)。</p> <p><strong>调用示例 1：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> withHooks<span class="token punctuation">,</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue-hooks&quot;</span>

<span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token function">withHooks</span><span class="token punctuation">(</span>h <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">&quot;count is &quot;</span> <span class="token operator">+</span> count
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;span&quot;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`count is: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> on<span class="token punctuation">:</span> <span class="token punctuation">{</span> click<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;+&quot;</span> <span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>代码中，通过 useEffect 使每当 count 的状态值变化时，都会重置 document.title。</p> <p>注意：这里没有指定 useEffect 的第二个参数 deps，表示只要组件重新渲染都会执行 useEffect 指定的逻辑，不限制必须是 count 变化时。useEffect 详细的参数说明，请参考：<a href="https://reactjs.org/docs/hooks-effect.html" target="_blank" rel="noopener noreferrer">Using the Effect Hook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>调用示例 2：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> withHooks<span class="token punctuation">,</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue-hooks&quot;</span>

<span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token function">withHooks</span><span class="token punctuation">(</span>h <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>width<span class="token punctuation">,</span> setWidth<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleResize</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setWidth</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;resize&quot;</span><span class="token punctuation">,</span> handleResize<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;resize&quot;</span><span class="token punctuation">,</span> handleResize<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`window width is: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>代码中，通过 useEffect 控制在窗口改变时重新获取其宽度。</p> <p>useEffect 第一个参数的返回值，如果是函数的话，则定义其为清理逻辑。清理逻辑会在组件需要重新执行 useEffect 逻辑之前，或组件被销毁时执行。</p> <p>这里在 useEffect 逻辑中，为 window 对象添加了 resize 事件，那么就需要在组件销毁时或需要重新执行该副作用逻辑时，先把 resize 事件注销掉，以避免不必要的事件处理。</p> <p>另外，需要注意，这里 useEffect 的第二个参数的值是 []，表明无依赖项，只在组件创建后执行一次，这样处理也符合这里的上下文场景。</p> <p><strong>useEffect 实现细节:</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useEffect</span><span class="token punctuation">(</span>rawEffect<span class="token punctuation">,</span> deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ensureCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token operator">++</span>callIndex
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMounting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 组件挂载前，重新包装「清理逻辑」与「副作用逻辑」。</span>
    <span class="token keyword">const</span> <span class="token function-variable function">cleanup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> current <span class="token punctuation">}</span> <span class="token operator">=</span> cleanup
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 清理逻辑执行完，则重置回 null；</span>
        <span class="token comment">// 如果副作用逻辑二次执行，cleanup.current 会被重新赋值。</span>
        cleanup<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> current <span class="token punctuation">}</span> <span class="token operator">=</span> effect
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// rawEffect 的返回值，如果是一个函数的话，则定义为 useEffect副作用 的清理函数。</span>
        cleanup<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// rawEffect 执行完，则重置为 null；</span>
        <span class="token comment">// 如果相关的 deps 发生变化，需要二次执行 rawEffect 时 effect.current 会被重新赋值。</span>
        effect<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    effect<span class="token punctuation">.</span>current <span class="token operator">=</span> rawEffect
    <span class="token comment">// 在组件实例上，存储 useEffect 相关辅助成员。</span>
    currentInstance<span class="token punctuation">.</span>_effectStore<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      effect<span class="token punctuation">,</span>
      cleanup<span class="token punctuation">,</span>
      deps
    <span class="token punctuation">}</span>
    <span class="token comment">// 组件实例 mounted 时，执行 useEffect 逻辑。</span>
    currentInstance<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'hook:mounted'</span><span class="token punctuation">,</span> effect<span class="token punctuation">)</span>
    <span class="token comment">// 组件实例 destroyed 时，执行 useEffect 相关清理逻辑。</span>
    currentInstance<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'hook:destroyed'</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span>
    <span class="token comment">// 若未指定依赖项或存在明确的依赖项时，组件实例 updated 后，执行 useEffect 逻辑。</span>
    <span class="token comment">// 若指定依赖项为 [], 则 useEffect 只会在 mounted 时执行一次。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps <span class="token operator">||</span> deps<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentInstance<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'hook:updated'</span><span class="token punctuation">,</span> effect<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> record <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>_effectStore<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> effect<span class="token punctuation">,</span> cleanup<span class="token punctuation">,</span> deps<span class="token punctuation">:</span> prevDeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token operator">=</span> record
    record<span class="token punctuation">.</span>deps <span class="token operator">=</span> deps
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps <span class="token operator">||</span> deps<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> d <span class="token operator">!==</span> prevDeps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 若依赖的状态值有变动时，在副作用重新执行前，执行清理逻辑。</span>
      <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// useEffect 执行完毕后，会将 current 的属性置为 null. 这里为 effect.current 重新赋值，</span>
      <span class="token comment">// 是为了在 updated 后执行 rawEffect 逻辑。</span>
      effect<span class="token punctuation">.</span>current <span class="token operator">=</span> rawEffect
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到 useEffect 的实现比较精巧，涉及到了组件的三个生命周期：mounted、updated、destroyed。</p> <p>副作用逻辑的执行细节由 deps 控制：</p> <ul><li>mounted 时，固定地执行一次。</li> <li>如果 deps 未指定，则每次 updated 后都执行一次。</li> <li>如果 deps 为空数组，则 updated 后不执行。</li> <li>如果 deps 指定了依赖项，则当相应的依赖项的值改变时，执行一次。</li></ul> <p>通过参数，我们可以为 useEffect 指定 3 种信息：</p> <ul><li>rawEffect - 副作用逻辑内容。</li> <li>清理逻辑 - 通过 rawEffect 的返回值定义。</li> <li>依赖 - 定义何时需要重复执行副作用逻辑。</li></ul> <p>其中，清理逻辑，会在 2 种情况下执行：</p> <ul><li>rawEffect 需要重复执行之前，清理上次运行所带来的副作用。</li> <li>组件销毁时。</li></ul> <h3 id="useref"><a href="#useref" aria-hidden="true" class="header-anchor">#</a> useRef</h3> <p>相当于为组件添加一个本地变量 -- 非状态。</p> <p><strong>方法签名：</strong></p> <blockquote><p>const refContainer = useRef(initialValue)</p></blockquote> <p><strong>useRef 实现细节：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRef</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ensureCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token operator">++</span>callIndex
  <span class="token keyword">const</span> <span class="token punctuation">{</span> _refsStore<span class="token punctuation">:</span> refs <span class="token punctuation">}</span> <span class="token operator">=</span> currentInstance
  <span class="token keyword">return</span> isMounting <span class="token operator">?</span>
    <span class="token punctuation">(</span>refs<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      current<span class="token punctuation">:</span> initial
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
    refs<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码中，useRef 指定的初始值，连同组件本身的 refs 定义，被存储到了内部对象 _refsStore 中。在组件的渲染函数中，随时可拿到 ref 对象：refContainer，并获取或修改其中的 current 属性。</p> <h3 id="usemounted"><a href="#usemounted" aria-hidden="true" class="header-anchor">#</a> useMounted</h3> <p>添加需要在 mounted 事件中执行的逻辑。</p> <p><strong>useMounted 实现细节：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useMounted</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个就比较简单了，上文中提到，如果 useEffect 的参数 deps 指定为空数组的话，fn 就不在 updated 后执行了 -- 即仅在 mounted 时执行一次.</p> <h3 id="usedestroyed"><a href="#usedestroyed" aria-hidden="true" class="header-anchor">#</a> useDestroyed</h3> <p>添加需要在 destroyed 阶段执行的逻辑。</p> <p><strong>useDestroyed 实现细节：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useDestroyed</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fn<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上文中提到 useEffect 第一个参数的返回值，如果是函数的话，会在 destroyed 阶段作为清理逻辑执行。</p> <p>这里通过设置参数 deps 的值为空数组，并把 fn 指定为 useEffect 的副作用逻辑的返回值，使 fn 在 destroyed 阶段执行。</p> <h3 id="useupdated"><a href="#useupdated" aria-hidden="true" class="header-anchor">#</a> useUpdated</h3> <p>添加需要在组件更新后执行的逻辑。</p> <p><strong>useUpdated 实现细节：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useUpdated</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isMount <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token comment">// 通过 useRef 生成一个标识符。</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isMount<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isMount<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 跳过 mounted.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> deps<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>也是通过 useEffect 实现，这里的副作用逻辑本身未指定，fn 定义在了清理逻辑的位置，每次组件更新都会执行。</p> <h3 id="usewatch"><a href="#usewatch" aria-hidden="true" class="header-anchor">#</a> useWatch</h3> <p>为组件添加 watch.</p> <p><strong>useWatch 实现细节：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useWatch</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ensureCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMounting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentInstance<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>直接通过组件实例的 $watch 方法实现。</p> <h3 id="usecomputed"><a href="#usecomputed" aria-hidden="true" class="header-anchor">#</a> useComputed</h3> <p>为组件添加 computed 属性。</p> <p><strong>useComputed 实现细节：</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useComputed</span><span class="token punctuation">(</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ensureCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token operator">++</span>callIndex
  <span class="token keyword">const</span> store <span class="token operator">=</span> currentInstance<span class="token punctuation">.</span>_computedStore
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMounting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    store<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    currentInstance<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>
      getter<span class="token punctuation">,</span>
      val <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> store<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> val <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> sync<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> store<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>本质上也是通过组件实例的 $watch 实现。</p> <h3 id="完整代码及示例"><a href="#完整代码及示例" aria-hidden="true" class="header-anchor">#</a> 完整代码及示例</h3> <p>请参考：<a href="https://github.com/yyx990803/vue-hooks" target="_blank" rel="noopener noreferrer">POC of vue-hooks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="结论"><a href="#结论" aria-hidden="true" class="header-anchor">#</a> 结论</h2> <ul><li>Hooks API 是个中立的概念，也可以在 Vue、或其它组件系统中使用，如：<a href="https://github.com/matthewp/haunted" target="_blank" rel="noopener noreferrer">React's Hooks API implemented for web components<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>通过 Hooks 使我们能够切入组件生命周期的各个环节，为函数式的纯组件装配行为。模块化粒度更细了，代码复用度高，也更高内聚松耦合了。</li> <li>以「纯组件 + Hooks」的方式开发组件，我们基本上告别了捉摸不定的 this，代码更函数式了。未来也方便更进一步地使用函数式的柯里化、组合、惰性计算等诸多优势，编写更简洁健壮的代码。</li> <li>通过 Hooks，使我们能够根据业务逻辑的相关性组织代码模块，摆脱了类组件格式的限制。</li></ul></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/blog/old/css-tricks.html">
          关于CSS伪元素及伪类的使用
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/blog/assets/js/app.65fb4c50.js" defer></script><script src="/blog/assets/js/5.4bb80ee7.js" defer></script>
  </body>
</html>
